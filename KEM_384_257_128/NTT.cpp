#include "NTT.h"
#include "utils.h"
#include "parameters.h"
#include <avr/pgmspace.h>

const PROGMEM int psi_rev[N]     = {1,-16,64,4,-8,128,2,-32,-121,-120,-34,30,-60,-68,15,17,81,-11,44,67,123,88,-95,-22,-35,46,73,117,23,-111,-70,92,9,113,62,36,-72,124,18,-31,-61,-52,-49,13,-26,-98,-122,-104,-42,-99,-118,89,79,21,-84,59,-58,-100,-114,25,-50,29,-116,57,3,-48,-65,12,-24,127,6,-96,-106,-103,-102,90,77,53,45,51,-14,-33,-125,-56,112,7,-28,-66,-105,-119,-38,94,69,-76,47,19,27,82,-71,108,41,115,54,-93,74,101,110,39,-78,-37,-109,-55,-126,-40,-97,10,-20,63,5,-80,83,-43,-85,75,107,87,-91,-86};
const PROGMEM int inv_psi_rev[N] = {86,91,-87,-107,-75,85,43,-83,80,-5,-63,20,-10,97,40,126,55,109,37,78,-39,-110,-101,-74,93,-54,-115,-41,-108,71,-82,-27,-19,-47,76,-69,-94,38,119,105,66,28,-7,-112,56,125,33,14,-51,-45,-53,-77,-90,102,103,106,96,-6,-127,24,-12,65,48,-3,-57,116,-29,50,-25,114,100,58,-59,84,-21,-79,-89,118,99,42,104,122,98,26,-13,49,52,61,31,-18,-124,72,-36,-62,-113,-9,-92,70,111,-23,-117,-73,-46,35,22,95,-88,-123,-67,-44,11,-81,-17,-15,68,60,-30,34,120,121,32,-2,-128,8,-4,-64,16,-1};


void NTT(Poly* p){
    int s, j, t, l, zeta, k=1;
    
    for(l=N>>1; l > 0; l >>= 1)
        for(s=0; s < N; s = j+l){
            zeta = pgm_read_word_near(psi_rev+k);
            k++;
            for(j=s; j < s+l; ++j){
              t = zeta*p->c[j+l];
              p->c[j+l] = mod_q(p->c[j] - t);
              p->c[j]   = mod_q(p->c[j] + t); 
            }
        }
}

void INTT(Poly* p){
    int s, j, t, l, k=0;

    for(l=1; l < N; l <<= 1)
        for(s=0; s < N; s = j+l){
            for(j=s; j < s+l; ++j){
                t = p->c[j];
                p->c[j] = mod_q(t+p->c[j+l]);
                p->c[j+l] = t - p->c[j+l]; 
                p->c[j+l] = mm257(pgm_read_word_near(inv_psi_rev+k),p->c[j+l]); 
            }
            ++k;
        }
    for(j=0; j < N; ++j) p->c[j] = mm257(p->c[j],inv_N);
}

